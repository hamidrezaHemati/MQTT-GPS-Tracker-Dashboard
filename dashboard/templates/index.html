<!DOCTYPE html>
<html lang="en">
<head>
  <title>Lock Pack Solutions</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Favicon -->
  <link rel="icon" type="image/svg" href="{{ url_for('static', filename='logo-02.svg') }}">
  <!-- Leaflet CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/flipdown/dist/flipdown.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
  <div class="container">
    <div class="left-panel">

      <!-- Fixed Main Navbar -->
      <ul class="ul0">
        <li class="horizon"><a class="active" href="#" data-section="devices">Devices</a></li>
        <li class="horizon"><a href="#" data-section="history">History</a></li>
        <li class="horizon"><a href="#" data-section="geo">Geo-fencing</a></li>
      </ul>

      <!-- Dynamic Left Panel Content -->
      <div id="left-content">

        <!-- Devices Section -->
        <div id="devices-section" class="section active">
          <div class="sub-navbar">
            <button id="add-device-btn">‚ûï Add Device</button>
          </div>
          <!-- Vertical Device List -->
          <ul class="ul1" id="device-list"></ul>
        </div>

        <!-- Device Page -->
        <div id="device-page" class="section">
          <div class="sub-navbar">
            <button id="back-to-devices">‚¨ÖÔ∏è Back</button>
          </div>

          <div class="device-card">
            <div class="device-card-content">
              <h4 id="device-title"></h4>
            </div>
          </div>

         <div class="status-card">
          
          <div class="top-cards">
            
            <div class="highlighted-card">
              <img src="{{ url_for('static', filename='icons/clock.png') }}" class="highlighted-icon">
              <div class="param-info">
                <span class="param-label">Time:</span>
                <span id="param-time" class="param-value">--:--:--</span>
              </div>
            </div>

            <div class="highlighted-card">
              <img src="{{ url_for('static', filename='icons/gps_2.png') }}" class="highlighted-icon">
              <div class="param-info">
                <span class="param-label">Latitude:</span>
                <span id="param-lat" class="param-value">--</span>
                <span class="param-label">Longitude:</span>
                <span id="param-lon" class="param-value">--</span>
              </div>
            </div>

            <div class="highlighted-card">
              <img src="{{ url_for('static', filename='icons/lock.png') }}" class="highlighted-icon">
              <div class="param-info">
                <span class="param-label">Lock status</span>
                <span id="param-lock" class="param-value">--</span>
              </div>
            </div>

            <div class="highlighted-card">
              <img src="{{ url_for('static', filename='icons/full-battery.png') }}" class="highlighted-icon">
              <div class="param-info">
                <span class="param-label">Battery</span>
                <span id="param-batt" class="param-value">--%</span>
              </div>
            </div>
          </div>

          <div class="bottom-cards">
            
            <div class="normal-card">
              <img src="{{ url_for('static', filename='icons/temp.png') }}" class="normal-icon">
              <div class="param-info">
                <span class="param-label">Temperature</span>
                <span id="param-temp" class="param-value">-- ¬∞C</span>
              </div>
            </div>

            <div class="normal-card">
              <img src="{{ url_for('static', filename='icons/wifi.png') }}" class="normal-icon">
              <div class="param-info">
                <span class="param-label">RSSI</span>
                <span id="param-rssi" class="param-value">--</span>
              </div>
            </div>

            <div class="normal-card">
              <!-- <img src="{{ url_for('static', filename='icons/counter.png') }}" class="normal-icon"> -->
              <div class="param-info">
                <span class="param-label">Msg Counter</span>
                <div id="msg-counter" class="flip-counter">0</div>
              </div>
            </div>

            <div class="normal-card">
              <img src="{{ url_for('static', filename='icons/box.png') }}" class="normal-icon">
              <div class="param-info">
                <span class="param-label">Queue</span>
                <span id="param-queued" class="param-value">--</span>
              </div>
            </div>
          </div>

          <div class="alarm-cards">
            
            <div class="alarm-card">
              <img src="{{ url_for('static', filename='icons/rfid.png') }}" class="highlighted-icon">
              <div class="param-info">
                <span class="param-label">RFID Serial number:</span>
                <span id="param-todo" class="alarm-value">--</span>
                <span class="param-label">Attempted Time:</span>
                <span id="param-time" class="alarm-value">--:--:--</span>
              </div>
            </div>

            <div class="alarm-card">
              <img src="{{ url_for('static', filename='icons/zone.png') }}" class="highlighted-icon">
              <div class="param-info">
                <div class="param-row">
                  <span class="param-label">Zone Name:</span>
                  <span id="param-zone" class="alarm-value">Not Specified</span>
                </div>
                <div class="param-row">
                  <span class="param-label">Zone notification:</span>
                  <span id="param-notif" class="alarm-value">--</span>
                </div>
                <div class="param-row">
                  <span class="param-label">Attempted Time:</span>
                  <span id="param-time" class="alarm-value">--:--:--</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="command-cards">
            <div class="command-card" id="rfid-command-btn" onclick="rfidOnModal()">
              <img src="{{ url_for('static', filename='icons/rfid1.png') }}" alt="rfid Command">
            </div>

            <div class="command-card" id="lock-command-btn" onclick="openLockModal()">
              <img src="{{ url_for('static', filename='icons/key.png') }}" alt="Lock Command">
            </div>

            <div class="command-card" id="config-command-btn" onclick="openConfigModal()">
              <img src="{{ url_for('static', filename='icons/stop-watch.png') }}" alt="Config Wait">
            </div>
          </div>

        </div>

          <!-- <div id="device-console" style="font-family: monospace; background: #ebe6e6; color: rgb(4, 116, 4); padding: 1em; height: 350px; overflow-y: auto;">
            Waiting for messages...
          </div> -->
        </div>

        <!-- History Section -->
        <div id="history-section" class="section">
          <h3>History View</h3>
          <p>Coming soon...</p>
        </div>

        <!-- Geo-fencing Section -->
        <div id="geo-section" class="section">
          <h3>Geo-fencing</h3>
          <p>Coming soon...</p>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div id="map"></div>
    </div>
  </div>

  <!-- Modal Form for Adding Device -->
  <div id="device-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Add New Device</h3>
      <form id="add-device-form">
        <input type="text" id="new-IMEI" placeholder="IMEI" required><br>
        <button type="submit">Add Device</button>
      </form>
    </div>
  </div>

<!-- Config rfid Modal -->
<div id="rfid-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeRFIDModal()">&times;</span>
    <h3>Turn On/Off RFID modlue</h3>
    <form id="rfid-form">
      <select id="rfid-command">
        <option value="on">ON</option>
        <option value="of">OFF</option>
      </select>
      <br><br>
      <button type="submit">Send</button>
    </form>
  </div>
</div>

<!-- Lock Command Modal -->
<div id="lock-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeLockModal()">&times;</span>
    <h3>Send Lock Command</h3>
    <form id="lock-form">
      <select id="lock-command">
        <option value="lock_open">Open</option>
        <option value="lock_close">Close</option>
      </select>
      <br><br>
      <button type="submit">Send</button>
    </form>
  </div>
</div>

<!-- Config Wait Modal -->
<div id="wit-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeConfigModal()">&times;</span>
    <h3>Set Wake-up Interval Time for device (seconds)</h3>
    <form id="wit-form">
      <input type="number" id="wit-time" placeholder="30" min="1" required>
      <br><br>
      <button type="submit">Send</button>
    </form>
  </div>
</div>

  <script>
    // Initial gpsPoint from Flask
    let map;
    let deviceMarkers = {};
    let deviceColors = {};  // to store IMEI ‚Üí color mapping
    let currentIMEI = null;   // üëà define global variable


    // Available colors
    const availableColors = [
      "red", "blue", "green", "orange", "yellow",
      "violet", "grey", "black"
    ];

    function initMap() {
      // Define different tile layers (map styles)
      const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
      });

      const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3'],
        attribution: '¬© Google'
      });

      const terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: '¬© OpenTopoMap'
      });

      // Initialize map with streets as default
      map = L.map('map', {
        center: [35.729015, 51.824891],
        zoom: 16,
        layers: [streets]  // default layer
      });

      // Layer control to switch between map styles
      const baseMaps = {
        "Streets": streets,
        "Satellite": satellite,
        "Terrain": terrain
      };
      L.control.layers(baseMaps).addTo(map);
    }

    // Create a standard pin icon with custom color
    function getPinIcon(color) {
      return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],   // size of the icon
        iconAnchor: [12, 41], // point of the icon which corresponds to marker location
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
    }

    // Assign a consistent color per IMEI
    function getDeviceColor(imei) {
      if (!deviceColors[imei]) {
        const colorIndex = Object.keys(deviceColors).length % availableColors.length;
        deviceColors[imei] = availableColors[colorIndex];
      }
      return deviceColors[imei];
    }

    async function updateDeviceLocation(imei) {
      try {
        const res = await fetch(`/device_location/${imei}`);
        const data = await res.json();

        if (data.success) {
          const pos = [data.lat, data.lon];
          const color = getDeviceColor(imei);

          if (!deviceMarkers[imei]) {
            // first time: create marker with unique color
            deviceMarkers[imei] = L.marker(pos, { icon: getPinIcon(color) })
              .addTo(map)
              .bindPopup(`üöõ ${imei}`);
          } else {
            // update position
            deviceMarkers[imei].setLatLng(pos);
          }
        }
      } catch (err) {
        console.error("Error updating location:", err);
      }
    }

    // continuously update ALL active devices
    function startUpdatingLocations(IMEI) {
      setInterval(() => {
        updateDeviceLocation(IMEI);
      }, 1000); // every 2s
    }

    document.addEventListener("DOMContentLoaded", () => {
      initMap();
    });

    function rfidOnModal() { document.getElementById("rfid-modal").style.display = "block"; }
    function closeRFIDModal() { document.getElementById("rfid-modal").style.display = "none"; }
    function openLockModal() { document.getElementById("lock-modal").style.display = "block"; }
    function closeLockModal() { document.getElementById("lock-modal").style.display = "none"; }
    function openConfigModal() { document.getElementById("wit-modal").style.display = "block"; }
    function closeConfigModal() { document.getElementById("wit-modal").style.display = "none"; }

    // rfid command submit
    document.getElementById("rfid-form").addEventListener("submit", async e => {
      e.preventDefault();
      let rfid = document.getElementById("rfid-command").value;
      try {
        console.log(`/publish/${currentIMEI}/rfid`);
        await fetch(`/publish/${currentIMEI}/rfid`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ rfid: rfid })
        });
        alert("‚úÖ RFID command sent!");
        closeLockModal();
      } catch (err) {
        alert("‚ùå Failed to send RFID command");
        console.error(err);
      }
    });

    // Lock command submit
    document.getElementById("lock-form").addEventListener("submit", async e => {
      e.preventDefault();
      const command = document.getElementById("lock-command").value;
      try {
        await fetch(`/publish/${currentIMEI}/lock`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ command: command })
        });
        alert("‚úÖ Lock command sent!");
        closeLockModal();
      } catch (err) {
        alert("‚ùå Failed to send lock command");
        console.error(err);
      }
    });

    // Config wait submit
    document.getElementById("wit-form").addEventListener("submit", async e => {
      e.preventDefault();
      const time = document.getElementById("wit-time").value;
      const value = "wit_on_" + time;   // based on topic and msgs structure

      try {
        await fetch(`/publish/${currentIMEI}/wit`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wait_time: value })
        });
        alert("‚úÖ Config wait time sent!");
        closeConfigModal();
      } catch (err) {
        alert("‚ùå Failed to send config");
        console.error(err);
      }
    });

    // Device console
    let consoleInterval = null;
    function startDeviceConsole(IMEI) {
      if (consoleInterval) clearInterval(consoleInterval);

      async function fetchDeviceData() {
        try {
          const response = await fetch(`/data/${IMEI}`);
          const data = await response.json();
          console.log("Device data:", data); // üëà Add this

          // const consoleDiv = document.getElementById("device-console");
          // consoleDiv.innerHTML = "";

          if (data.length > 0) {
            const latest = data[0];  

            document.getElementById("param-time").textContent = `${latest.HH}:${latest.MM}:${latest.SS}`;
            document.getElementById("param-lat").textContent = latest.lat;
            document.getElementById("param-lon").textContent = latest.lon;
            // document.getElementById("param-alt").textContent = latest.Alt; // only if you add it to HTML
            document.getElementById("param-batt").textContent = latest.Batt + "%";
            document.getElementById("param-lock").textContent = latest["Lock Status"];
            document.getElementById("param-temp").textContent = latest.Temperature + " ¬∞C";
            document.getElementById("param-rssi").textContent = latest.RSSI;
            // document.getElementById("param-cnt").textContent = latest.Cnt;
            updateFlipCounter(latest.Cnt);
            document.getElementById("param-queued").textContent = latest.isQueued;
          } else {
            // Reset to default values when no data is available
            document.getElementById("param-time").textContent = "--:--:--";
            document.getElementById("param-lat").textContent = "--";
            document.getElementById("param-lon").textContent = "--";
            document.getElementById("param-batt").textContent = "--%";
            document.getElementById("param-lock").textContent = "--";
            document.getElementById("param-temp").textContent = "-- ¬∞C";
            document.getElementById("param-rssi").textContent = "--";
            updateFlipCounter(0);
            document.getElementById("param-queued").textContent = "--";
          }

          // still print all messages in console
          // data.forEach(msg => {
          //   const line = `[${msg.timestamp}] ${msg.topic} ‚Üí ${msg.HH}:${msg.MM}:${msg.SS}, ${msg.lat}, ${msg.lon}, ${msg.Alt}, ${msg.Batt}, ${msg["Lock Status"]}, ${msg.Temprature}, ${msg.RSSI}, ${msg.Cnt}, ${msg.isQueued}`;
          //   const p = document.createElement("div");
          //   p.textContent = line;
          //   consoleDiv.appendChild(p);
          // });
        } catch (err) {
          console.error("Error fetching device data:", err);
        }
      }


      fetchDeviceData();
      consoleInterval = setInterval(fetchDeviceData, 2000);
    }

    // Navbar switching
    document.querySelectorAll(".ul0 a").forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        document.querySelectorAll(".ul0 a").forEach(a => a.classList.remove("active"));
        link.classList.add("active");

        const section = link.dataset.section;
        document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
        document.getElementById(section + "-section").classList.add("active");
      });
    });

    // Back to devices button
    document.getElementById("back-to-devices").addEventListener("click", () => {
      document.getElementById("device-page").classList.remove("active");
      document.getElementById("devices-section").classList.add("active");
    });

    // Modal open/close
    const modal = document.getElementById("device-modal");
    document.getElementById("add-device-btn").onclick = () => modal.style.display = "block";
    document.querySelector(".close").onclick = () => modal.style.display = "none";
    window.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

    // Add device form
    document.getElementById("add-device-form").addEventListener("submit", async e => {
      e.preventDefault();
      const IMEI = document.getElementById("new-IMEI").value;

      try {
        const response = await fetch("/connect", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ IMEI: IMEI })
        });
        const result = await response.json();

        if (result.status === "connected") {
          const li = document.createElement("li");
          li.className = "device-card";
          li.innerHTML = `
            <div class="device-card-content">
              <img src="{{ url_for('static', filename='icons/truck.png') }}" class="normal-icon">
              <h4>${IMEI}</h4>
            </div>
          `;
          li.dataset.device = IMEI;
          document.getElementById("device-list").appendChild(li);


          li.addEventListener("click", () => {
            document.querySelectorAll("#device-list li").forEach(li => li.classList.remove("active"));
            li.classList.add("active");

            document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
            document.getElementById("device-page").classList.add("active");

            document.getElementById("device-title").textContent = `üöõ ${IMEI}`;
            // document.getElementById("device-console").innerHTML =
            //   `<b>${IMEI}</b> selected<br>Waiting for messages...`;
            currentIMEI = IMEI
            startDeviceConsole(IMEI);
            startUpdatingLocations(IMEI);
          });

          alert("‚úÖ Connected to device " + IMEI);
          modal.style.display = "none";
          document.getElementById("add-device-form").reset();
        } else {
          alert("‚ùå " + result.message);
        }
      } catch (err) {
        console.error("Error connecting device:", err);
        alert("‚ö†Ô∏è Failed to connect to server.");
      }
    });

    let lastCnt = 0;

    function updateFlipCounter(newValue) {
      const container = document.getElementById("msg-counter");
      const oldValue = lastCnt;

      if (newValue === oldValue) return; // no change

      container.innerHTML = ""; // clear digits
      const digits = String(newValue).split("");

      digits.forEach((d, i) => {
        const span = document.createElement("span");
        span.className = "flip-digit";
        span.textContent = d;
        container.appendChild(span);

        // trigger flip if digit changed
        if (String(oldValue).padStart(digits.length, "0")[i] !== d) {
          setTimeout(() => span.classList.add("flip"), 50);
          setTimeout(() => span.classList.remove("flip"), 600);
        }
      });

      lastCnt = newValue;
    }
  </script>
</body>
</html>
